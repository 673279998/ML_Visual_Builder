<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å‹ç®¡ç† - ML Visual Builder</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/visualization.css">
    <!-- Chart.js -->
    <script src="js/libs/chart.umd.min.js"></script>
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="logo">
                <h1>ML Visual Builder</h1>
                <p>æ¨¡å‹ç®¡ç†</p>
            </div>
            <nav class="main-nav">
                <a href="index.html" class="nav-link">å·¥ä½œæµ</a>
                <a href="data_editor.html" class="nav-link">æ•°æ®ç®¡ç†</a>
                <a href="#" class="nav-link active" data-page="models">æ¨¡å‹ç®¡ç†</a>
                <a href="predict.html" class="nav-link">æ¨¡å‹é¢„æµ‹</a>
                <a href="help.html" class="nav-link">å¸®åŠ©</a>
            </nav>
            <div class="header-actions">
                <button class="btn btn-warning" id="btn-cleanup" style="margin-right: 10px; background-color: #faad14; border-color: #faad14; color: white;">æ¸…ç†åƒåœ¾æ–‡ä»¶</button>
                <button class="btn btn-secondary" id="btn-refresh">åˆ·æ–°åˆ—è¡¨</button>
            </div>
        </header>

        <div class="main-container">
            <!-- æ¨¡å‹åˆ—è¡¨ -->
            <div id="models-list-view" style="display: block;">
                <div class="list-toolbar" style="padding: 20px 20px 0 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div class="select-controls">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="select-all-models">
                            <span>å…¨é€‰</span>
                        </label>
                    </div>
                    <div class="batch-actions">
                        <button class="btn btn-danger" id="btn-batch-delete" disabled style="background-color: #ff4d4f; color: white; opacity: 0.5; cursor: not-allowed;">
                            æ‰¹é‡åˆ é™¤ <span id="selected-count" style="display: none;">(0)</span>
                        </button>
                    </div>
                </div>
                <div class="model-list" id="model-list">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>åŠ è½½æ¨¡å‹åˆ—è¡¨ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- æ¨¡å‹è¯¦æƒ… -->
            <div id="model-detail-view" style="display: none;">
                <div class="results-container">
                    <div style="padding: 20px; background: white; margin-bottom: 20px; border-radius: 8px;">
                        <button class="btn btn-secondary" id="btn-back-to-list">â† è¿”å›åˆ—è¡¨</button>
                        <h2 id="model-title" style="margin: 20px 0 10px 0;"></h2>
                        <p id="model-subtitle" style="color: #666;"></p>
                    </div>
                    
                    <div id="results-content"></div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨çŠ¶æ€æ  -->
        <footer class="status-bar">
            <div class="status-left">
                <span id="status-message">å°±ç»ª</span>
            </div>
            <div class="status-right">
                <span id="model-count">æ¨¡å‹æ•°: 0</span>
            </div>
        </footer>
    </div>

    <script src="js/utils/api-client.js"></script>
    <script src="js/utils/ui-helper.js"></script>
    <script src="js/visualization/result_visualizer.js"></script>
    <script>
        // æ¨¡å‹ç®¡ç†å™¨
        class ModelManager {
            constructor() {
                this.visualizer = new ResultVisualizer();
                this.models = [];
                this.currentModelId = null;
                this.selectedModels = new Set();
                this.init();
            }
            
            init() {
                this.loadModels();
                this.bindEvents();
            }
            
            bindEvents() {
                document.getElementById('btn-refresh').addEventListener('click', () => {
                    this.loadModels();
                });
                
                document.getElementById('btn-cleanup').addEventListener('click', () => {
                    this.cleanupSystem();
                });
                
                document.getElementById('btn-back-to-list').addEventListener('click', () => {
                    this.showListView();
                });

                // æ‰¹é‡æ“ä½œäº‹ä»¶
                document.getElementById('select-all-models').addEventListener('change', (e) => {
                    this.toggleSelectAll(e.target.checked);
                });

                document.getElementById('btn-batch-delete').addEventListener('click', () => {
                    this.deleteSelectedModels();
                });
            }
            
            async loadModels() {
                try {
                    this.showMessage('åŠ è½½ä¸­...', 'info');
                    
                    const result = await apiClient.getModels();
                    
                    if (result.success) {
                        this.models = result.data || [];
                        this.selectedModels.clear();
                        this.updateSelectionUI();
                        this.renderModelList();
                        this.showMessage('å°±ç»ª', 'success');
                        document.getElementById('model-count').textContent = `æ¨¡å‹æ•°: ${this.models.length}`;
                    } else {
                        throw new Error(result.error || 'åŠ è½½å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', error);
                    this.showMessage('åŠ è½½å¤±è´¥', 'error');
                    this.showEmptyState('åŠ è½½æ¨¡å‹å¤±è´¥: ' + error.message);
                }
            }
            
            renderModelList() {
                const container = document.getElementById('model-list');
                
                if (this.models.length === 0) {
                    this.showEmptyState('æš‚æ— è®­ç»ƒçš„æ¨¡å‹');
                    return;
                }
                
                container.innerHTML = '';
                
                this.models.forEach(model => {
                    const card = this.createModelCard(model);
                    container.appendChild(card);
                });
            }
            
            createModelCard(model) {
                const card = document.createElement('div');
                card.className = 'model-card';
                
                // è·å–ä¸»è¦æŒ‡æ ‡
                const metrics = model.performance_metrics || {};
                let mainMetrics = [];
                
                if (model.algorithm_type === 'classification') {
                    if (metrics.accuracy !== undefined) {
                        mainMetrics.push({ label: 'å‡†ç¡®ç‡', value: (metrics.accuracy * 100).toFixed(2) + '%' });
                    }
                    if (metrics.f1_score !== undefined) {
                        mainMetrics.push({ label: 'F1åˆ†æ•°', value: metrics.f1_score.toFixed(4) });
                    }
                } else if (model.algorithm_type === 'regression') {
                    if (metrics.r2 !== undefined) {
                        mainMetrics.push({ label: 'RÂ²', value: metrics.r2.toFixed(4) });
                    }
                    if (metrics.rmse !== undefined) {
                        mainMetrics.push({ label: 'RMSE', value: metrics.rmse.toFixed(4) });
                    }
                }
                
                card.innerHTML = `
                    <div class="model-card-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" class="model-select-checkbox" value="${model.id}" 
                                onclick="event.stopPropagation(); modelManager.toggleSelection(${model.id})"
                                ${this.selectedModels.has(model.id) ? 'checked' : ''}>
                            <div class="model-name" title="${model.name}">${model.name || `æ¨¡å‹ ${model.id}`}</div>
                        </div>
                        <div class="model-type-badge ${model.algorithm_type}">
                            ${this.getAlgorithmTypeText(model.algorithm_type)}
                        </div>
                    </div>
                    <div class="model-info">
                        ç®—æ³•: ${model.algorithm_name || 'æœªçŸ¥'}<br>
                        åˆ›å»ºæ—¶é—´: ${new Date(model.created_at).toLocaleString('zh-CN')}
                    </div>
                    ${mainMetrics.length > 0 ? `
                    <div class="model-metrics">
                        ${mainMetrics.map(m => `
                            <div class="model-metric-item">
                                <span class="model-metric-label">${m.label}:</span>
                                <span class="model-metric-value">${m.value}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    <div class="model-actions">
                        <button class="btn btn-primary" onclick="modelManager.viewModelResults(${model.id})">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                        <button class="btn btn-secondary" onclick="modelManager.deleteModel(${model.id})">
                            åˆ é™¤
                        </button>
                    </div>
                `;
                
                // ç‚¹å‡»å¡ç‰‡ä»»æ„ä½ç½®ï¼ˆé™¤äº†æŒ‰é’®å’Œcheckboxï¼‰ä¹Ÿå¯ä»¥æŸ¥çœ‹è¯¦æƒ…
                card.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                        this.viewModelResults(model.id);
                    }
                });

                return card;
            }

            toggleSelection(modelId) {
                if (this.selectedModels.has(modelId)) {
                    this.selectedModels.delete(modelId);
                } else {
                    this.selectedModels.add(modelId);
                }
                this.updateSelectionUI();
            }

            toggleSelectAll(checked) {
                if (checked) {
                    this.models.forEach(m => this.selectedModels.add(m.id));
                } else {
                    this.selectedModels.clear();
                }
                
                // æ›´æ–°æ‰€æœ‰checkbox
                document.querySelectorAll('.model-select-checkbox').forEach(cb => {
                    cb.checked = checked;
                });
                
                this.updateSelectionUI();
            }

            updateSelectionUI() {
                const count = this.selectedModels.size;
                const btn = document.getElementById('btn-batch-delete');
                const countSpan = document.getElementById('selected-count');
                const selectAllCb = document.getElementById('select-all-models');
                
                if (count > 0) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    countSpan.textContent = `(${count})`;
                    countSpan.style.display = 'inline';
                } else {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    countSpan.style.display = 'none';
                }
                
                // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
                if (this.models.length > 0 && count === this.models.length) {
                    selectAllCb.checked = true;
                    selectAllCb.indeterminate = false;
                } else if (count > 0) {
                    selectAllCb.checked = false;
                    selectAllCb.indeterminate = true;
                } else {
                    selectAllCb.checked = false;
                    selectAllCb.indeterminate = false;
                }
            }

            async deleteSelectedModels() {
                const count = this.selectedModels.size;
                if (count === 0) return;

                const confirmed = await UIHelper.confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªæ¨¡å‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`, 'æ‰¹é‡åˆ é™¤ç¡®è®¤');
                if (!confirmed) return;

                try {
                    this.showMessage('æ­£åœ¨æ‰¹é‡åˆ é™¤...', 'info');
                    
                    // è°ƒç”¨æ‰¹é‡åˆ é™¤API
                    const modelIds = Array.from(this.selectedModels);
                    const result = await apiClient.post('/api/models/batch', { model_ids: modelIds });
                    
                    if (result.success) {
                        UIHelper.showMessage(`æˆåŠŸåˆ é™¤ ${result.deleted_count} ä¸ªæ¨¡å‹`, 'success');
                        if (result.errors && result.errors.length > 0) {
                            console.warn('éƒ¨åˆ†åˆ é™¤å¤±è´¥:', result.errors);
                        }
                        this.loadModels();
                    } else {
                        throw new Error(result.error || 'æ‰¹é‡åˆ é™¤å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
                    this.showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥', 'error');
                    UIHelper.showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                }
            }
            
            getAlgorithmTypeText(type) {
                const typeMap = {
                    'classification': 'åˆ†ç±»',
                    'regression': 'å›å½’',
                    'clustering': 'èšç±»',
                    'dimensionality_reduction': 'é™ç»´'
                };
                return typeMap[type] || type;
            }
            
            async viewModelResults(modelId) {
                try {
                    this.showMessage('åŠ è½½æ¨¡å‹è¯¦æƒ…...', 'info');
                    
                    const result = await apiClient.getModel(modelId);
                    
                    if (result.success) {
                        this.currentModelId = modelId;
                        this.showDetailView(result.data);
                        this.showMessage('å°±ç»ª', 'success');
                    } else {
                        throw new Error(result.error || 'åŠ è½½å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åŠ è½½æ¨¡å‹è¯¦æƒ…å¤±è´¥:', error);
                    this.showMessage('åŠ è½½å¤±è´¥', 'error');
                    UIHelper.showMessage('åŠ è½½æ¨¡å‹è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
                }
            }
            
            showDetailView(model) {
                // åˆ‡æ¢è§†å›¾
                document.getElementById('models-list-view').style.display = 'none';
                document.getElementById('model-detail-view').style.display = 'block';
                
                // è®¾ç½®æ ‡é¢˜
                document.getElementById('model-title').textContent = model.name || `æ¨¡å‹ ${model.id}`;
                document.getElementById('model-subtitle').textContent = 
                    `${model.algorithm_name} - ${this.getAlgorithmTypeText(model.algorithm_type)} - ${new Date(model.created_at).toLocaleString('zh-CN')}`;
                
                // æ¸…ç©ºä¹‹å‰çš„å›¾è¡¨
                this.visualizer.clearAll();
                
                // æ¸²æŸ“ç»“æœ
                this.visualizer.renderTrainingResults('results-content', {
                    algorithm_type: model.algorithm_type,
                    algorithm_name: model.algorithm_name,
                    performance_metrics: model.performance_metrics,
                    complete_results: model.complete_results,
                    feature_importance: model.feature_importance
                });
            }
            
            showListView() {
                document.getElementById('models-list-view').style.display = 'block';
                document.getElementById('model-detail-view').style.display = 'none';
                this.currentModelId = null;
                this.visualizer.clearAll();
            }
            
            async deleteModel(modelId) {
                const confirmed = await UIHelper.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡å‹å—ï¼Ÿ', 'ç¡®è®¤åˆ é™¤');
                if (!confirmed) {
                    return;
                }
                
                try {
                    this.showMessage('åˆ é™¤ä¸­...', 'info');
                    
                    const result = await apiClient.deleteModel(modelId);
                    
                    if (result.success) {
                        UIHelper.showMessage('åˆ é™¤æˆåŠŸ', 'success');
                        this.loadModels();
                    } else {
                        throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åˆ é™¤æ¨¡å‹å¤±è´¥:', error);
                    this.showMessage('åˆ é™¤å¤±è´¥', 'error');
                    UIHelper.showMessage('åˆ é™¤æ¨¡å‹å¤±è´¥: ' + error.message, 'error');
                }
            }

            async cleanupSystem() {
                const confirmed = await UIHelper.confirm('ç¡®å®šè¦æ¸…ç†ç³»ç»Ÿä¸­çš„æ— ç”¨æ–‡ä»¶å—ï¼Ÿ\nè¿™å°†åˆ é™¤æœªä½¿ç”¨çš„å¤„ç†åæ•°æ®é›†ã€æ¨¡å‹æ–‡ä»¶ã€é¢„æµ‹ç»“æœå’Œä¸´æ—¶æ–‡ä»¶ã€‚', 'ç¡®è®¤æ¸…ç†');
                if (!confirmed) return;

                try {
                    this.showMessage('æ­£åœ¨æ¸…ç†ç³»ç»Ÿæ–‡ä»¶...', 'info');
                    
                    const response = await fetch('/api/system/cleanup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        const data = result.data;
                        // æ ¼å¼åŒ–æ˜¾ç¤ºæ¸…ç†ç»“æœ
                        const msg = [
                            'æ¸…ç†å®Œæˆï¼',
                            `åˆ é™¤æ•°æ®é›†: ${data.datasets_deleted}`,
                            `åˆ é™¤æ¨¡å‹æ–‡ä»¶: ${data.models_deleted}`,
                            `åˆ é™¤é¢„æµ‹æ–‡ä»¶: ${data.predictions_deleted}`,
                            `åˆ é™¤ç»„ä»¶æ–‡ä»¶: ${data.components_deleted}`
                        ].join('\n');
                        
                        UIHelper.showMessage(msg, 'success');
                        this.loadModels(); 
                    } else {
                        throw new Error(result.error || 'æ¸…ç†å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æ¸…ç†å¤±è´¥:', error);
                    UIHelper.showMessage('æ¸…ç†å¤±è´¥: ' + error.message, 'error');
                } finally {
                    this.showMessage('å°±ç»ª', 'info');
                }
            }
            
            showEmptyState(message) {
                const container = document.getElementById('model-list');
                container.innerHTML = `
                    <div class="empty-results">
                        <div class="empty-results-icon">ğŸ“Š</div>
                        <h3>æš‚æ— æ¨¡å‹</h3>
                        <p>${message}</p>
                        <a href="index.html" class="btn btn-primary">å¼€å§‹è®­ç»ƒæ¨¡å‹</a>
                    </div>
                `;
            }
            
            showMessage(message, type = 'info') {
                const statusEl = document.getElementById('status-message');
                statusEl.textContent = message;
                statusEl.className = `status-${type}`;
            }
        }
        
        // åˆå§‹åŒ–
        const modelManager = new ModelManager();
    </script>
</body>
</html>
